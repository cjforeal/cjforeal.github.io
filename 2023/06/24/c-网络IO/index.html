<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="cjforeal">





<title>c#ç½‘ç»œIO | Cjforeal(é¼»å±æ‹Œé¥­)</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">cj&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">cj&#39;s Blog</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">c#ç½‘ç»œIO</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">cjforeal</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">å…­æœˆ 24, 2023&nbsp;&nbsp;16:36:21</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/c/">c#</a>
                            
                        </span>
                     


                    
                        <span class="post-count">
                    Words:
                            <a href="">2.4k</a> 
                        </span>
                    

                    
                    
                        <span class="post-count">
                    Time:
                            <a href="">9min</a> 
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>å‰ä¸‰æ®µç–¯ç‹‚CVğŸ˜šğŸ˜šğŸ˜šğŸ˜š</p>
</blockquote>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p>åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œæ‰€è°“çš„I&#x2F;Oå°±æ˜¯ <strong>è¾“å…¥ï¼ˆInputï¼‰å’Œè¾“å‡ºï¼ˆOutputï¼‰</strong>ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸º<strong>è¯»ï¼ˆReadï¼‰å’Œå†™ï¼ˆWrite)<strong>ï¼Œé’ˆå¯¹ä¸åŒçš„å¯¹è±¡ï¼ŒI&#x2F;Oæ¨¡å¼å¯ä»¥åˆ’åˆ†ä¸º</strong>ç£ç›˜IO</strong>æ¨¡å‹å’Œ<strong>ç½‘ç»œIO</strong>æ¨¡å‹ã€‚</p>
<p>IOæ“ä½œä¼šæ¶‰åŠåˆ°<strong>ç”¨æˆ·ç©ºé—´</strong>å’Œ<strong>å†…æ ¸ç©ºé—´</strong>çš„è½¬æ¢ï¼Œå…ˆæ¥ç†è§£ä»¥ä¸‹è§„åˆ™ï¼š</p>
<ul>
<li>å†…å­˜ç©ºé—´åˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼Œä¹Ÿç§°ä¸ºç”¨æˆ·ç¼“å†²åŒºå’Œå†…æ ¸ç¼“å†²åŒºï¼›</li>
<li>ç”¨æˆ·çš„åº”ç”¨ç¨‹åºä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ç©ºé—´ï¼Œéœ€è¦å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´æ‰èƒ½ä½¿ç”¨ï¼›</li>
<li>æ— è®ºæ˜¯readæ“ä½œï¼Œè¿˜æ˜¯writeæ“ä½œï¼Œéƒ½åªèƒ½åœ¨å†…æ ¸ç©ºé—´é‡Œæ‰§è¡Œï¼›</li>
<li>ç£ç›˜IOå’Œç½‘ç»œIOè¯·æ±‚åŠ è½½åˆ°å†…å­˜çš„æ•°æ®éƒ½æ˜¯å…ˆæ”¾åœ¨å†…æ ¸ç©ºé—´çš„ï¼›</li>
</ul>
<p>å†æ¥çœ‹çœ‹æ‰€è°“çš„è¯»ï¼ˆReadï¼‰å’Œå†™ï¼ˆWrite)æ“ä½œï¼š</p>
<ul>
<li><strong>è¯»æ“ä½œ</strong>ï¼šæ“ä½œç³»ç»Ÿæ£€æŸ¥å†…æ ¸ç¼“å†²åŒºæœ‰æ²¡æœ‰éœ€è¦çš„æ•°æ®ï¼Œå¦‚æœå†…æ ¸ç¼“å†²åŒºå·²ç»æœ‰éœ€è¦çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠŠå†…æ ¸ç©ºé—´çš„æ•°æ®copyåˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾›ç”¨æˆ·çš„åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚å¦‚æœå†…æ ¸ç¼“å†²åŒºæ²¡æœ‰éœ€è¦çš„æ•°æ®ï¼Œå¯¹äºç£ç›˜IOï¼Œç›´æ¥ä»ç£ç›˜ä¸­è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºï¼ˆè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ä¸éœ€è¦cpuå‚ä¸ï¼‰ã€‚è€Œå¯¹äºç½‘ç»œIOï¼Œåº”ç”¨ç¨‹åºéœ€è¦ç­‰å¾…å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œä»ç½‘å¡ä¸­å»å–æ•°æ®ã€‚</li>
<li><strong>å†™æ“ä½œ</strong>ï¼šç”¨æˆ·çš„åº”ç”¨ç¨‹åºå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´copyåˆ°å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºä¸­ï¼ˆå¦‚æœç”¨æˆ·ç©ºé—´æ²¡æœ‰ç›¸åº”çš„æ•°æ®ï¼Œåˆ™éœ€è¦ä»ç£ç›˜â€”&gt;å†…æ ¸ç¼“å†²åŒºâ€”&gt;ç”¨æˆ·ç¼“å†²åŒºä¾æ¬¡è¯»å–ï¼‰ï¼Œè¿™æ—¶å¯¹ç”¨æˆ·ç¨‹åºæ¥è¯´å†™æ“ä½œå°±å·²ç»å®Œæˆï¼Œè‡³äºä»€ä¹ˆæ—¶å€™å†å†™åˆ°ç£ç›˜æˆ–é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šã€‚é™¤éåº”ç”¨ç¨‹åºæ˜¾ç¤ºåœ°è°ƒç”¨äº†sync å‘½ä»¤ï¼Œç«‹å³æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œæˆ–æ‰§è¡Œflush()æ–¹æ³•ï¼Œé€šè¿‡ç½‘ç»œæŠŠæ•°æ®å‘é€å‡ºå»ã€‚</li>
</ul>
<h2 id="ç”¨æˆ·ç©ºé—´-amp-å†…æ ¸ç©ºé—´"><a href="#ç”¨æˆ·ç©ºé—´-amp-å†…æ ¸ç©ºé—´" class="headerlink" title="ç”¨æˆ·ç©ºé—´&amp;å†…æ ¸ç©ºé—´"></a>ç”¨æˆ·ç©ºé—´&amp;å†…æ ¸ç©ºé—´</h2><p> Linux æ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µé‡Œï¼Œè™šæ‹Ÿå†…å­˜ï¼ˆæ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µï¼Œå’Œç‰©ç†å†…å­˜æ˜¯å¯¹åº”çš„ï¼‰è¢«æ“ä½œç³»ç»Ÿåˆ’åˆ†æˆä¸¤å—ï¼šUser Spaceï¼ˆç”¨æˆ·ç©ºé—´ å’Œ Kernel Spaceï¼ˆå†…æ ¸ç©ºé—´ï¼‰ï¼Œæœ¬è´¨ä¸Šç”µè„‘çš„ç‰©ç†å†…å­˜æ˜¯ä¸åˆ’åˆ†è¿™äº›çš„ï¼Œåªæ˜¯æ“ä½œç³»ç»Ÿå¼€æœºå¯åŠ¨ååœ¨é€»è¾‘ä¸Šè™šæ‹Ÿåˆ’åˆ†äº†åœ°å€å’Œç©ºé—´èŒƒå›´ã€‚</p>
<p>æ“ä½œç³»ç»Ÿä¼šç»™æ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ã€è¿ç»­çš„è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ï¼ˆç‰©ç†ä¸Šå¯èƒ½ä¸è¿ç»­ï¼‰ï¼Œä»¥32ä½æ“ä½œç³»ç»Ÿä¸ºä¾‹ï¼Œè¯¥å¤§å°ä¸€èˆ¬æ˜¯4Gï¼Œå³232 ã€‚å…¶ä¸­å°†é«˜åœ°å€å€¼çš„å†…å­˜ç©ºé—´åˆ†é…ç»™ç³»ç»Ÿå†…æ ¸å ç”¨ï¼ˆç½‘ä¸ŠæŸ¥èµ„æ–™å¾—çŸ¥ï¼šLinuxä¸‹å 1Gï¼ŒWindowsä¸‹å 2Gï¼‰ï¼Œå…¶ä½™çš„å†…å­˜åœ°å€ç©ºé—´åˆ†é…ç»™ç”¨æˆ·è¿›ç¨‹ä½¿ç”¨ã€‚</p>
<p>ç®€å•è¯´ï¼Œ<strong>å†…æ ¸ç©ºé—´</strong> æ˜¯æ“ä½œç³»ç»Ÿ <strong>å†…æ ¸ä»£ç è¿è¡Œçš„åœ°æ–¹</strong>ï¼Œ<strong>ç”¨æˆ·ç©ºé—´</strong> æ˜¯ <strong>ç”¨æˆ·ç¨‹åºä»£ç è¿è¡Œçš„åœ°æ–¹</strong>ã€‚å½“åº”ç”¨è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ä»£ç ä¸­æ‰§è¡Œæ—¶å°±å¤„äº<strong>å†…æ ¸æ€</strong>ï¼Œå½“åº”ç”¨è¿›ç¨‹åœ¨è¿è¡Œç”¨æˆ·ä»£ç æ—¶å°±å¤„äº<strong>ç”¨æˆ·æ€</strong>ã€‚</p>
<p>åŒæ—¶å†…æ ¸ç©ºé—´å¯ä»¥æ‰§è¡Œä»»æ„çš„å‘½ä»¤ï¼Œè€Œç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œç®€å•çš„è¿ç®—ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºå’Œæ•°æ®ã€‚å¿…é¡»é€šè¿‡æ“ä½œç³»ç»Ÿæä¾›æ¥å£ï¼Œå‘ç³»ç»Ÿå†…æ ¸å‘é€æŒ‡ä»¤ã€‚</p>
<p>ä¸€æ—¦è°ƒç”¨ç³»ç»Ÿæ¥å£ï¼Œåº”ç”¨è¿›ç¨‹å°±ä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´äº†ï¼Œå› ä¸ºå¼€å§‹è¿è¡Œå†…æ ¸ä»£ç äº†ã€‚</p>
<h2 id="äº†è§£ä¸€ç§è®¾å¤‡ä¸å†…å­˜çš„æ•°æ®ä¼ è¾“æ–¹å¼-DMA"><a href="#äº†è§£ä¸€ç§è®¾å¤‡ä¸å†…å­˜çš„æ•°æ®ä¼ è¾“æ–¹å¼-DMA" class="headerlink" title="äº†è§£ä¸€ç§è®¾å¤‡ä¸å†…å­˜çš„æ•°æ®ä¼ è¾“æ–¹å¼:DMA"></a>äº†è§£ä¸€ç§è®¾å¤‡ä¸å†…å­˜çš„æ•°æ®ä¼ è¾“æ–¹å¼:DMA</h2><p>DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼ŒDirect Memory Accessï¼‰ã€‚</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡readç­‰ç³»ç»Ÿè°ƒç”¨æ¥å£å‘æ“ä½œç³»ç»Ÿï¼ˆå³CPUï¼‰å‘å‡ºIOè¯·æ±‚ï¼Œè¯·æ±‚è¯»å–æ•°æ®åˆ°è‡ªå·±çš„ç”¨æˆ·å†…å­˜ç¼“å†²åŒºä¸­ï¼Œç„¶åè¯¥è¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚</li>
<li>æ“ä½œç³»ç»Ÿæ”¶åˆ°ç”¨æˆ·è¿›ç¨‹çš„è¯·æ±‚åï¼Œè¿›ä¸€æ­¥å°†IOè¯·æ±‚å‘é€ç»™DMAï¼Œç„¶åCPUå°±å¯ä»¥å»å¹²åˆ«çš„äº‹äº†ã€‚</li>
<li>DMAå°†IOè¯·æ±‚è½¬å‘ç»™ç£ç›˜ã€‚</li>
<li>ç£ç›˜é©±åŠ¨å™¨æ”¶åˆ°å†…æ ¸çš„IOè¯·æ±‚åï¼ŒæŠŠæ•°æ®è¯»å–åˆ°è‡ªå·±çš„ç¼“å†²åŒºä¸­ï¼Œå½“ç£ç›˜çš„ç¼“å†²åŒºè¢«è¯»æ»¡åï¼Œå‘DMAå‘èµ·ä¸­æ–­ä¿¡å·å‘ŠçŸ¥è‡ªå·±ç¼“å†²åŒºå·²æ»¡ã€‚</li>
<li>DMAæ”¶åˆ°ç£ç›˜é©±åŠ¨å™¨çš„ä¿¡å·ï¼Œå°†ç£ç›˜ç¼“å†²åŒºä¸­çš„æ•°æ®copyåˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œæ­¤æ—¶ä¸å ç”¨CPUï¼ˆ PIO è¿™é‡Œæ˜¯å ç”¨CPUçš„ï¼‰ã€‚</li>
<li>å¦‚æœå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®å°‘äºç”¨æˆ·ç”³è¯·è¯»çš„æ•°æ®ï¼Œåˆ™é‡å¤æ­¥éª¤3ã€4ã€5ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®ç¬¦åˆç”¨æˆ·çš„è¦æ±‚ä¸ºæ­¢ã€‚</li>
<li>å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®å·²ç»ç¬¦åˆç”¨æˆ·çš„è¦æ±‚ï¼ŒDMAåœæ­¢å‘ç£ç›˜å‘IOè¯·æ±‚ã€‚</li>
<li>DMAå‘é€ä¸­æ–­ä¿¡å·ç»™CPUã€‚</li>
<li>CPUæ”¶åˆ°DMAçš„ä¿¡å·ï¼ŒçŸ¥é“æ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œäºæ˜¯å°†æ•°æ®ä»å†…æ ¸ç©ºé—´copyåˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚</li>
<li>ç”¨æˆ·è¿›ç¨‹è¯»å–åˆ°æ•°æ®åç»§ç»­æ‰§è¡ŒåŸæ¥çš„ä»»åŠ¡ã€‚</li>
</ol>
<p>è·ŸPIOæ¨¡å¼ç›¸æ¯”ï¼ŒDMAå°±æ˜¯CPUçš„ä¸€ä¸ªä»£ç†ï¼Œå®ƒè´Ÿè´£äº†ä¸€éƒ¨åˆ†çš„æ‹·è´å·¥ä½œ(ç£ç›˜&#x2F;ç½‘å¡ç¼“å­˜åŒºä¸å†…æ ¸ç¼“å­˜åŒºä¹‹é—´çš„æ‹·è´)ï¼Œä»è€Œå‡è½»äº†CPUçš„è´Ÿæ‹…ã€‚è€Œå†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´å·¥ä½œä»ç„¶ç”±CPUè´Ÿè´£ã€‚</p>
<blockquote>
<p>ä»¥ï½ƒï¼ƒReceiveï¼ˆï¼‰ä¸ºä¾‹ï¼Œå±•ç¤ºä¸åŒç½‘ç»œï¼©ï¼¯æ¨¡å‹çš„ä¼ªä»£ç </p>
</blockquote>
<p>æ¢³ç†ä¸€æ¬¡Receiveï¼ˆï¼‰çš„è¿‡ç¨‹</p>
<ul>
<li><p>å®¢æˆ·ç«¯å‘é€æ•°æ®,ä¿å­˜åœ¨ç½‘å¡ç¼“å­˜åŒºä¸­</p>
</li>
<li><p>ç”¨æˆ·è¿›ç¨‹å‘CPUå‘é€IOè¯·æ±‚,CPUè½¬æ‰‹ç»™DMA,DMAè½¬å‘IOè¯·æ±‚åˆ°ç½‘å¡(ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„ä¸€æ¬¡è½¬æ¢)</p>
</li>
<li><p>ç½‘å¡å°†socket buffer Copyåˆ°å†…æ ¸ç¼“å­˜åŒºä¸­</p>
</li>
<li><p>å†…æ ¸ç¼“å­˜åŒºæ•°æ®å·²æ»¡æˆ–è€…å·²è¾¾åˆ°ç”¨æˆ·éœ€è¦,å°†buffer æ‹·è´åˆ°ç”¨æˆ·ç¼“å­˜åŒºä¸­(å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„ä¸€æ¬¡è½¬æ¢)</p>
</li>
</ul>
<p>æ³¨æ„çš„æ˜¯ä¸åŒç¼“å­˜åŒºä¹‹é—´çš„æ¶ˆæ¯copyéƒ½æ˜¯é˜»å¡å¼çš„(DMAè´Ÿè´£çš„éƒ¨åˆ†éé˜»å¡b)ï¼ŒåŒæ—¶å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„è½¬æ¢æ˜¯å­˜åœ¨ä¸å¯å¿½è§†çš„cpuæ¶ˆè€—çš„.</p>
<h2 id="é˜»å¡IO"><a href="#é˜»å¡IO" class="headerlink" title="é˜»å¡IO"></a>é˜»å¡IO</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">byte</span>[] buffer=<span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="built_in">int</span> len= socket.Receive(buffer);</span><br></pre></td></tr></table></figure>

<p>å½“è°ƒç”¨Receiveæ—¶, ä¸åŒç¼“å­˜åŒºé—´çš„æ•°æ®æ‹·è´,å’Œå®¢æˆ·ç«¯æ•°æ®çš„ç­‰å¾…ä¼šé˜»å¡å½“å‰çº¿ç¨‹,é€šå¸¸ä¼šæ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ¥è¿›è¡Œæ­¤æ“ä½œ.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Socket s= socket.Accept();</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(R);</span><br><span class="line">t.Start(s);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">R</span>(<span class="params"><span class="built_in">object</span> s</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Socket skt = s <span class="keyword">as</span> Socket;</span><br><span class="line"><span class="built_in">byte</span>[] buffer=<span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="built_in">int</span> len= skt.Receive(buffer);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å½“è¿æ¥æ•°å¾ˆå¤šæ—¶,å…¶å¼€è¾Ÿçº¿ç¨‹çš„æ¶ˆè€—å’Œå¤šçº¿ç¨‹çš„å ç”¨é€šå¸¸éš¾ä»¥æ¥å—;</p>
<h2 id="éé˜»å¡IO"><a href="#éé˜»å¡IO" class="headerlink" title="éé˜»å¡IO"></a>éé˜»å¡IO</h2><p>ä¸ºäº†è§£å†³é˜»å¡çš„é—®é¢˜,æˆ‘ä»¬åªèƒ½ä¾é æ“ä½œç³»ç»Ÿæä¾›çš„æ¥å£,ä»–ä¼šå¸®åŠ©æˆ‘ä»¬æ£€æŸ¥å†…æ ¸ç¼“å­˜åŒºæ•°æ®æ˜¯å¦æ»¡è¶³éœ€æ±‚,è‹¥æ»¡è¶³,åˆ™æ‹·è´å†…æ ¸ç¼“å­˜åŒºçš„æ•°æ®åˆ°ç”¨æˆ·æ€,å¦åˆ™ç«‹å³è¿”å›ä¸€ä¸ªå¤±è´¥æ ‡è®°(c#ä¼šè¿”å›ä¸€ä¸ª<code>SocketException å¦‚ErrorCode==10035</code>),ä»¥è¾¾åˆ°éé˜»å¡çš„æ•ˆæœ.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Socket s= socket.Accept();</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">//è®¾ç½®éé˜»å¡</span></span><br><span class="line">s.Blocking = <span class="literal">false</span>;</span><br><span class="line">Thread t = <span class="keyword">new</span> Thread(R);</span><br><span class="line">t.Start(s);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">R</span>(<span class="params"><span class="built_in">object</span> s</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Socket skt = s <span class="keyword">as</span> Socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">int</span> len = skt.Receive(buffer);</span><br><span class="line">        <span class="comment">//æ¥æ”¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(SocketException ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(ex.ErrorCode==<span class="number">10035</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//å¤„ç†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å¤šè¿æ¥æ—¶,æˆ‘ä»¬é€šå¸¸ä¼šä¿å­˜ä¸€ä¸ªclient socketç»„,ä»¥éå†éé˜»å¡å¼è½®è¯¢.	</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Socket s= socket.Accept();</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line">List&lt;Socket&gt; socketList= <span class="keyword">new</span> List&lt;Socket&gt;();</span><br><span class="line">socketList.Add(s);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> skt <span class="keyword">in</span> socketList)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">int</span> len = skt.Receive(buffer);</span><br><span class="line">        <span class="comment">//æ¥æ”¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (SocketException ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex.ErrorCode == <span class="number">10035</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//å¤„ç†</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,æ¯æ¬¡è°ƒç”¨Receive()æ—¶éƒ½ä¼šæ˜¯ä¸€æ¬¡å¯¹CPUèµ„æºçš„æ¶ˆè€—,æ¶‰åŠç”¨æˆ·æ€å†…æ ¸æ€çš„è½¬æ¢.</p>
<p>æœ‰æ²¡æœ‰å¯èƒ½åªè°ƒç”¨ä¸€æ¬¡cpuå‘½ä»¤,è®©å†…æ ¸æ€å¸®æˆ‘ä»¬éå†æ‰€æœ‰çš„client socketçš„çŠ¶æ€å‘¢?</p>
<p>ç­”æ¡ˆå°±æ˜¯ä¸‹é¢çš„å¤šè·¯å¤ç”¨IO.</p>
<h2 id="IOå¤šè·¯å¤ç”¨"><a href="#IOå¤šè·¯å¤ç”¨" class="headerlink" title="IOå¤šè·¯å¤ç”¨"></a>IOå¤šè·¯å¤ç”¨</h2><p>å¤šè·¯å¤ç”¨æŒ‡çš„æ˜¯å¤ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥æ£€æŸ¥å¤šä¸ªSocketçš„å°±ç»ªçŠ¶æ€.</p>
<p>c#æä¾›äº†ä¸¤ä¸ªæ–¹å¼æ¥åœ¨è§„å®šæ—¶é—´å†…ç¡®å®šSocketçŠ¶æ€,ä¸¤è€…éƒ½æ˜¯åŒæ­¥é˜»å¡çš„.</p>
<ol>
<li><code>Poll(Int32 timeout, SelectMode)</code>: æ£€æŸ¥å½“å‰Socket</li>
<li><code>Select (System.Collections.IList? checkRead, System.Collections.IList? checkWrite, System.Collections.IList? checkError, TimeSpan timeout)</code>:æ£€æŸ¥å¤šä¸ªSocket</li>
</ol>
<p>select è°ƒç”¨éœ€è¦ä¼ å…¥ socket æ•°ç»„ï¼Œéœ€è¦æ‹·è´ä¸€ä»½åˆ°å†…æ ¸ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹è¿™æ ·çš„æ‹·è´æ¶ˆè€—çš„èµ„æºæ˜¯æƒŠäººçš„ã€‚</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SelectSocket</span>(<span class="params"><span class="built_in">object</span>? args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(active)</span><br><span class="line">    &#123;</span><br><span class="line">        ResetCheckRead();</span><br><span class="line">        Socket.Select(checkRead, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">var</span> a <span class="keyword">in</span> checkRead)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (a == server)</span><br><span class="line">                AcceptClient(a);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                clients[a].ReadClientfd();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="keyword">var</span> c <span class="keyword">in</span> clients.Values)</span><br><span class="line">    &#123;</span><br><span class="line">        c.Close();  </span><br><span class="line">    &#125;</span><br><span class="line">    server.Shutdown(SocketShutdown.Both);</span><br><span class="line">    server.Close();</span><br><span class="line">    server = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å¼‚æ­¥IO"><a href="#å¼‚æ­¥IO" class="headerlink" title="å¼‚æ­¥IO"></a>å¼‚æ­¥IO</h2><p>c#å¼‚æ­¥ç½‘ç»œIOæ—¨åœ¨äºä½¿ç”¨c#çš„å¼‚æ­¥æ¨¡å¼,è®©c#è‡ªå·±è´Ÿè´£å¯¹IOçš„ç›‘å¬,è‹¥å®Œæˆ,åˆ™è‡ªåŠ¨è°ƒç”¨æˆ‘ä»¬å‘å‰è®¢é˜…çš„å›è°ƒæ–¹æ³•.å›è°ƒæ–¹æ³•åœ¨å…¶ä»–çº¿ç¨‹ä¸­è¿›è¡Œ,ä¸é˜»å¡å½“å‰çº¿ç¨‹</p>
<p>c#å¯¹æ­¤æä¾›äº†ä¸‰ç§å¼‚æ­¥IOæ–¹å¼</p>
<ol>
<li><p>æ—©æœŸçš„APMæœºåˆ¶ä¸‹çš„<code>BeginReceive()</code> <code> EndReceive()</code>ç­‰æ–¹æ³•:</p>
<p>å®˜æ–¹æ–‡æ¡£æ˜å†™ç€ä¸æ¨è,<code>The Begin/End design pattern currently implemented by the class requires a object be allocated for each asynchronous socket operation.</code>æ¯æ¬¡å¼‚æ­¥æ“ä½œæ—¶éƒ½éœ€è¦åˆ†é…ä¸€ä¸ª<em>IAsyncResult</em> å¯¹è±¡,èµ„æºæµªè´¹,åŠ å‰§GC.</p>
</li>
<li><p><code>SocketAsyncEventArgs</code> ç±»</p>
<p>å®˜æ–¹ç¤ºä¾‹ä»£ç :<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/system.net.sockets.socketasynceventargs?view=net-8.0">SocketAsyncEventArgsç±»ï¼ˆSystem.Net.Socketsï¼‰|å¾®è½¯å­¦ä¹  â€” SocketAsyncEventArgs Class (System.Net.Sockets) | Microsoft Learn</a></p>
</li>
<li><p>åœ¨<code>SocketAsyncEventArgs</code>å’Œ åŸºäºä»»åŠ¡çš„å¼‚æ­¥æ¨¡å¼åŸºç¡€ä¸Šå°è£…çš„<code>SocketTaskExtensions</code></p>
</li>
</ol>
<blockquote>
<p>ä¸€ä¸ªé«˜æ€§èƒ½ .NET I&#x2F;Oåº“ System.IO.Pipelines</p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>è¿™æ˜¯ä¸€ä»½</p>
<p>[1]: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/473639031">https://zhuanlan.zhihu.com/p/473639031</a>	â€œå¾ˆå…¨å¾ˆå…¨çš„IOåŸºç¡€çŸ¥è¯†ä¸æ¦‚å¿µâ€<br>[2]: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/473639031">https://zhuanlan.zhihu.com/p/473639031</a>	â€œIOå¤šè·¯å¤ç”¨åˆ°åº•æ˜¯ä¸æ˜¯å¼‚æ­¥çš„ï¼Ÿ - æ— èŠçš„é—ªå®¢çš„å›ç­” â€œ</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>cjforeal</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://cjforeal.github.io/2023/06/24/c-%E7%BD%91%E7%BB%9CIO/">https://cjforeal.github.io/2023/06/24/c-%E7%BD%91%E7%BB%9CIO/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/c-%E7%AC%94%E8%AE%B0/"># c#ç¬”è®°</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2023/07/13/%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%AE%9E%E8%B7%B5/">æ¸¸æˆæ€§èƒ½ä¼˜åŒ–+å®è·µ</a>
            
            
            <a class="next" rel="next" href="/2023/05/26/%E7%88%B6%E5%AD%90%E7%A2%B0%E6%92%9E%E9%9A%8F%E7%AC%94/">çˆ¶å­ç¢°æ’éšç¬”</a>
            
        </section>


    </article>
</div>

  
 <div id="gitalk-container"></div>  
 <link rel="stylesheet" href="//unpkg.com/gitalk/dist/gitalk.css">

<script src="//unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>

<div id="gitalk-container"></div>

<script type="text/javascript">

 var gitalk = new Gitalk({

 clientID: '3142d3c8eafcc4ea9dd7',

 clientSecret: 'c121752e97a91b3de38ddabdfc3e219b69efbd98',

 repo: 'cjforeal.github.io',

 owner: 'cjforeal',

 admin: 'cjforeal',

 id: md5(location.pathname), 

 labels: 'Gitalk'.split(',').filter(l => l),

 perPage: 15,

 pagerDirection: 'last',

 createIssueManually: true,

 distractionFreeMode: false

 })

 gitalk.render('gitalk-container')

</script>
  


            </div>
            <footer id="footer" class="footer">
 	<div class="copyright">
 		<span>Â© cjforeal | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a>
 |
 <!-- è®¿å®¢æ•°é‡ -->
 
 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
		<span class="site-uv">
		æ€»è®¿å®¢é‡:
 				<i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
			</span>&nbsp;
		
	
		<span class="site-pv">
		| æ€»è®¿é—®é‡:
				<i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
	</span>

 
 </span>
 	</div>
</footer>

    </div>
</body>

</html>